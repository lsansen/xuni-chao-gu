# 股票API集成文档

## 概述

本项目集成了多个免费的股票数据API，实现了API调用管理、频次控制、轮换机制、错误处理和监控功能。

## 集成的API列表

### 1. 腾讯财经API
- **API名称**: 腾讯财经
- **提供者**: ApiProvider.tencent
- **基础URL**: http://qt.gtimg.cn/q=
- **支持功能**: 实时股票数据
- **访问限制**: 
  - 每分钟最多60次调用
  - 每小时最多1000次调用
- **超时时间**: 15秒
- **最大重试次数**: 3次
- **使用条款**: 完全免费，无需注册
- **调用示例**: http://qt.gtimg.cn/q=sh600036
- **返回格式**: 字符串格式，包含股票名称、当前价格、昨收价等信息
- **数据说明**: 
  - 提供实时股票价格
  - 不提供历史K线数据
  - 响应速度快，稳定性高

### 2. 东方财富API
- **API名称**: 东方财富
- **提供者**: ApiProvider.eastMoney
- **基础URL**: http://push2his.eastmoney.com/api/qt/stock/kline/get
- **支持功能**: 历史K线数据
- **访问限制**: 
  - 每分钟最多30次调用
  - 每小时最多500次调用
- **超时时间**: 20秒
- **最大重试次数**: 3次
- **使用条款**: 完全免费，无需注册
- **调用示例**: http://push2his.eastmoney.com/api/qt/stock/kline/get?secid=1.600036&klt=101&fqt=1&end=1640995200000&lmt=30
- **返回格式**: JSON格式，包含K线数据
- **数据说明**: 
  - 提供历史K线数据
  - 支持日K、周K、月K
  - 支持前复权
  - 数据准确，更新及时

### 3. 新浪财经API
- **API名称**: 新浪财经
- **提供者**: ApiProvider.sina
- **基础URL**: https://hq.sinajs.cn/list=
- **支持功能**: 实时股票数据
- **访问限制**: 
  - 每分钟最多50次调用
  - 每小时最多800次调用
- **超时时间**: 15秒
- **最大重试次数**: 3次
- **使用条款**: 完全免费，无需注册
- **调用示例**: https://hq.sinajs.cn/list=sh600036
- **返回格式**: 字符串格式，包含股票名称、当前价格、昨收价等信息
- **数据说明**: 
  - 提供实时股票价格
  - 不提供历史K线数据
  - 响应速度快，稳定性高

### 4. 雪球API
- **API名称**: 雪球
- **提供者**: ApiProvider.xueqiu
- **基础URL**: https://xueqiu.com/
- **支持功能**: 实时和历史数据
- **访问限制**: 
  - 每分钟最多40次调用
  - 每小时最多600次调用
- **超时时间**: 20秒
- **最大重试次数**: 3次
- **使用条款**: 完全免费，无需注册
- **数据说明**: 
  - 提供实时股票价格
  - 提供历史K线数据
  - 数据准确，更新及时

## API管理机制

### 1. API调用管理
- **自动轮换**: 系统会自动轮换使用不同的API，避免过度依赖单一API
- **智能选择**: 根据API的调用限制和成功率智能选择最优API
- **负载均衡**: 均衡分配API调用，提高整体性能

### 2. API调用频次控制
- **每分钟限制**: 严格控制每个API的每分钟调用次数
- **每小时限制**: 严格控制每个API的每小时调用次数
- **自动重置**: 超过限制后自动重置计数器
- **实时监控**: 实时监控每个API的调用次数

### 3. API调用轮换机制
- **轮换策略**: 按顺序轮换使用不同的API
- **优先级**: 根据API的响应时间和成功率调整优先级
- **故障切换**: 当某个API失败时自动切换到其他API
- **负载均衡**: 均衡分配API调用，避免过载

### 4. 错误处理和重试机制
- **自动重试**: API调用失败时自动重试，最多3次
- **错误记录**: 记录所有API调用的错误信息
- **优雅降级**: 所有API都失败时使用模拟数据
- **异常捕获**: 捕获所有异常，确保应用稳定运行

### 5. API使用监控
- **调用次数**: 记录每个API的调用次数
- **成功率**: 计算每个API的成功率
- **响应时间**: 记录每个API的平均响应时间
- **最近调用**: 记录每个API的最近调用记录
- **统计信息**: 提供详细的API使用统计信息

## API配置参数

### ApiConfig类
```dart
class ApiConfig {
  final String name;              // API名称
  final ApiProvider provider;      // API提供者
  final String baseUrl;           // 基础URL
  final int maxCallsPerMinute;    // 每分钟最大调用次数
  final int maxCallsPerHour;      // 每小时最大调用次数
  final int maxRetries;          // 最大重试次数
  final Duration timeout;         // 超时时间
  final bool supportsRealTime;    // 是否支持实时数据
  final bool supportsHistorical;  // 是否支持历史数据
}
```

## API调用示例

### 获取股票数据
```dart
final stock = await ApiManager.getStockData('600036.SH', period: 'daily');
```

### 获取API统计信息
```dart
final stats = ApiManager.getAllApiStats();
```

### 获取特定API的统计信息
```dart
final stats = ApiManager.getApiStats(ApiProvider.tencent);
```

## API监控指标

### 调用次数
- 记录每个API的调用次数
- 按小时统计调用次数
- 用于分析API使用情况

### 成功率
- 计算每个API的成功率
- 成功率 = 成功次数 / 总调用次数
- 用于评估API的可靠性

### 响应时间
- 记录每个API的响应时间
- 计算平均响应时间
- 用于评估API的性能

### 最近调用记录
- 记录每个API的最近调用记录
- 最多保留100条记录
- 用于调试和分析问题

## API使用建议

1. **合理使用**: 不要过度调用API，遵守API的使用限制
2. **缓存数据**: 合理使用缓存，减少API调用次数
3. **错误处理**: 做好错误处理，确保应用稳定运行
4. **监控性能**: 定期检查API的性能指标，优化API使用策略
5. **及时更新**: 关注API的变化，及时更新代码

## 注意事项

1. 所有API都是免费的，但需要遵守使用限制
2. API可能会随时变化，需要及时更新代码
3. 部分API可能需要额外的参数，请参考API文档
4. 网络环境可能会影响API的响应速度
5. 建议在非交易时段进行API测试

## 未来优化方向

1. 添加更多免费API
2. 实现更智能的API选择策略
3. 添加API性能预测功能
4. 实现API负载均衡
5. 添加API健康检查功能
